<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack - School Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDKs (Compat version for file:// support) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',
                        secondary: '#3b82f6',
                        accent: '#f59e0b',
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin: 0 auto 20px auto;
            padding: 10mm;
            position: relative;
            box-sizing: border-box;
        }

        .admit-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10mm;
            height: 100%;
        }

        .admit-card {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: #fff;
        }

        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }

        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            @page { size: A4; margin: 0; }
            body > *:not(#printContainer) { display: none !important; }
            #printContainer { display: block !important; }
            #printContainer .a4-paper {
                width: 100%; height: 100vh; box-shadow: none; margin: 0; padding: 10mm;
                page-break-after: always;
            }
            #printContainer .a4-paper:last-child { page-break-after: auto; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        
        #printContainer { display: none; }
    </style>
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

    <div id="toast" class="fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded shadow-lg transform translate-x-full transition-transform duration-300 z-50">Action Successful</div>

    <div id="loadingOverlay" class="fixed inset-0 z-[60] bg-white bg-opacity-90 flex flex-col items-center justify-center hidden">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16 mb-4"></div>
        <h2 class="text-center text-gray-700 text-xl font-semibold">Loading...</h2>
        <p class="w-1/3 text-center text-gray-500">Connecting to database...</p>
    </div>

    <!-- PROMOTION MODAL -->
    <div id="promotionModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[70]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-75"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold text-blue-800"><i class="fas fa-graduation-cap"></i> Academic Promotion</p>
                </div>
                <div class="my-5">
                    <p class="font-semibold text-gray-800">The Academic Year has ended!</p>
                    <p class="text-sm text-gray-600 mt-2">The system is ready to promote students to the next class automatically.</p>
                    <ul class="list-disc list-inside text-sm text-gray-600 mt-2 bg-gray-100 p-3 rounded">
                        <li>Students move to the next class sequence.</li>
                        <li>Marks will be reset for the new session.</li>
                        <li>Final year students will move to Alumni.</li>
                    </ul>
                    <p class="text-red-500 text-xs mt-3 font-bold">⚠️ Note: This action cannot be undone automatically.</p>
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="toggleModal('promotionModal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Not Now</button>
                    <button onclick="executePromotion()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-bold">Promote Students</button>
                </div>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL (UPDATED WITH CLASS SELECT) -->
    <div id="editStudentModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">Edit Student Profile</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal('editStudentModal')"><i class="fas fa-times text-black"></i></div>
                </div>
                <div class="my-5 space-y-3">
                    <input type="hidden" id="editStuClassIdx"><input type="hidden" id="editStuIdx">
                    
                    <!-- Class Selection (New) -->
                    <div class="mb-2">
                        <label class="block text-sm font-bold mb-1 text-blue-800">Current Class</label>
                        <select id="editStuClassSelect" class="w-full border p-2 rounded bg-blue-50 border-blue-200"></select>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-sm font-bold mb-1">Roll No</label><input type="number" id="editStuRoll" class="w-full border p-2 rounded"></div>
                        <div><label class="block text-sm font-bold mb-1">Student ID</label><input type="text" id="editStuID" class="w-full border p-2 rounded"></div>
                    </div>
                    <div><label class="block text-sm font-bold mb-1">Student Name</label><input type="text" id="editStuName" class="w-full border p-2 rounded"></div>
                    <div><label class="block text-sm font-bold mb-1">Father's Name</label><input type="text" id="editStuFather" class="w-full border p-2 rounded"></div>
                    <div class="border-t pt-3 mt-3">
                        <h4 class="font-semibold text-gray-600 mb-2">Extra Details</h4>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="block text-xs text-gray-500 mb-1">Date of Birth</label><input type="date" id="editStuDOB" class="w-full border p-2 rounded"></div>
                            <div><label class="block text-xs text-gray-500 mb-1">Contact No</label><input type="text" id="editStuPhone" class="w-full border p-2 rounded"></div>
                        </div>
                        <div><label class="block text-xs text-gray-500 mb-1">Address</label><textarea id="editStuAddress" rows="2" class="w-full border p-2 rounded"></textarea></div>
                    </div>
                    <div class="flex justify-end pt-4">
                        <button onclick="toggleModal('editStudentModal')" class="bg-gray-300 text-gray-800 px-4 py-2 rounded mr-2">Cancel</button>
                        <button onclick="saveEditedStudent()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Update & Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="fixed inset-0 z-40 bg-gradient-to-br from-blue-900 to-blue-600 flex items-center justify-center">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-96 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <i class="fas fa-school text-5xl text-primary mb-3"></i>
                <h1 class="text-2xl font-bold text-gray-700">EduTrack Portal</h1>
            </div>
            <div class="flex mb-6 border-b">
                <button id="tabLogin" onclick="switchTab('login')" class="flex-1 py-2 text-blue-600 border-b-2 border-blue-600 font-bold focus:outline-none">Sign In</button>
                <button id="tabRegister" onclick="switchTab('register')" class="flex-1 py-2 text-gray-500 hover:text-blue-600 focus:outline-none">Register School</button>
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2">Email Address</label><input type="email" id="loginEmail" required class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-6"><label class="block text-gray-700 text-sm font-bold mb-2">Password</label><input type="password" id="loginPassword" required class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <button type="submit" class="w-full bg-primary text-white py-2 rounded hover:bg-blue-800 font-bold">Sign In</button>
            </form>

            <form id="registerForm" onsubmit="handleRegister(event)" class="hidden">
                <div class="mb-3"><label class="block text-gray-700 text-sm font-bold mb-1">School Name</label><input type="text" id="regSchoolName" required class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-3"><label class="block text-gray-700 text-sm font-bold mb-1">Email Address</label><input type="email" id="regEmail" required class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-3"><label class="block text-gray-700 text-sm font-bold mb-1">Password</label><input type="password" id="regPassword" required class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-1">Confirm Password</label><input type="password" id="regConfirmPassword" required class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-800 font-bold">Register School</button>
            </form>
            
            <div id="authError" class="mt-4 text-center text-red-500 text-sm hidden bg-red-50 p-2 rounded border border-red-200"></div>
        </div>
    </div>

    <!-- Print Area -->
    <div id="printContainer"></div>

    <!-- App Layout -->
    <div id="appLayout" class="flex h-full hidden">
        <aside class="w-64 bg-white shadow-md flex flex-col z-10">
            <div class="p-5 border-b flex items-center gap-3">
                <div class="bg-blue-100 p-2 rounded-full text-primary"><i class="fas fa-graduation-cap"></i></div>
                <div class="overflow-hidden w-full">
                    <h2 class="font-bold text-sm truncate cursor-pointer hover:text-blue-600" id="displaySchoolName" onclick="editSchoolProfile()" title="Edit Name">Loading...</h2>
                    <p class="text-xs text-gray-500 flex items-center cursor-pointer hover:text-blue-600" onclick="editSchoolProfile()" title="Edit Address">
                        <span id="displaySchoolAddress" class="truncate block max-w-[120px]">Add Address</span> 
                        <i class="fas fa-pencil-alt text-[10px] ml-1"></i>
                    </p>
                </div>
            </div>
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-2">
                    <li><button onclick="showSection('dashboardSection')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-gray-600"><i class="fas fa-th-large w-5"></i> Dashboard</button></li>
                    <li><button onclick="showSection('studentMasterSection')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-gray-600"><i class="fas fa-users w-5"></i> Student Master</button></li>
                    <li><button onclick="showSection('examConfigSection')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-gray-600"><i class="fas fa-cog w-5"></i> Exam & Subject creation</button></li>
                    <li><button onclick="showSection('routineSection')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-gray-600"><i class="fas fa-calendar-alt w-5"></i> Exam Routine</button></li>
                    <li><button onclick="showSection('marksEntrySection')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-gray-600"><i class="fas fa-edit w-5"></i> Enter Marks</button></li>
                    <li><button onclick="showSection('reportsSection')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-gray-600"><i class="fas fa-file-alt w-5"></i> Reports & Sheets</button></li>
                    <li><button onclick="showSection('progressSection')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-gray-600"><i class="fas fa-list-ol w-5"></i> Ranking List</button></li>
                    <li><button onclick="showSection('admitCardSection')" class="nav-btn w-full text-left px-4 py-3 rounded hover:bg-blue-50 text-gray-600"><i class="fas fa-id-card w-5"></i> Generate Admit Cards</button></li>
                </ul>
            </nav>
            <div class="p-4 border-t">
                <button onclick="handleLogout()" class="w-full px-4 py-2 text-red-600 hover:bg-red-50 rounded text-sm mb-2"><i class="fas fa-sign-out-alt"></i> Sign Out</button>
            </div>
        </aside>

        <main class="flex-1 bg-gray-100 overflow-y-auto p-8 relative">
            <div id="welcomeRibbon" class="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 rounded-lg shadow-md mb-6 flex items-center gap-3 hidden">
                <i class="fas fa-door-open text-2xl"></i>
                <div><h2 class="text-xl font-bold">Welcome, <span id="ribbonSchoolName">School Name</span></h2><p class="text-sm opacity-90">Manage your academic year efficiently.</p></div>
            </div>

            <div id="dashboardSection" class="section-content">
                <h1 class="text-2xl font-bold mb-6 text-gray-800">Dashboard</h1>
                
                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500"><div class="text-gray-500 text-sm">Total Students</div><div class="text-3xl font-bold text-gray-800" id="dashTotalStudents">0</div></div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500"><div class="text-gray-500 text-sm">Classes</div><div class="text-3xl font-bold text-gray-800" id="dashTotalClasses">0</div></div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500"><div class="text-gray-500 text-sm">Exams</div><div class="text-3xl font-bold text-gray-800" id="dashTotalExams">0</div></div>
                </div>

                <!-- Academic Session Config -->
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h3 class="font-bold text-lg text-gray-800 mb-4 border-b pb-2"><i class="fas fa-calendar-check text-blue-600 mr-2"></i>Academic Session Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-1">Session Start Date</label>
                            <input type="date" id="sessionStart" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-200">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-600 mb-1">Session End Date</label>
                            <input type="date" id="sessionEnd" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-200">
                        </div>
                        <div>
                            <button onclick="saveSessionDates()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full font-semibold shadow">Save Session Dates</button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle"></i> Once the End Date passes, the system will prompt you to automatically promote students to the next class.</p>
                </div>
            </div>

            <!-- STUDENT MASTER -->
            <div id="studentMasterSection" class="section-content hidden">
                <h1 class="text-2xl font-bold mb-6">Student Master</h1>
                <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                    <h3 class="text-lg font-semibold mb-4 border-b pb-2">1. Make Classes</h3>
                    <div class="flex gap-2 mb-4"><input type="text" id="newClassName" placeholder="Class Name (e.g., Class-X)" class="flex-1 border p-2 rounded"><button onclick="addClass()" class="bg-green-600 text-white px-4 py-2 rounded">Add Class</button></div>
                    <div id="classListContainer" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold mb-4 border-b pb-2">2. Entry Student Details</h3>
                    <select id="studentClassSelect" class="w-full border p-2 rounded mb-4" onchange="renderStudentList()"></select>
                    <div class="bg-gray-50 p-4 rounded border mb-4"><div class="grid grid-cols-1 md:grid-cols-5 gap-2"><input type="text" id="stuName" placeholder="Name" class="border p-2 rounded"><input type="text" id="stuFather" placeholder="Father's Name" class="border p-2 rounded"><input type="text" id="stuID" placeholder="ID" class="border p-2 rounded"><input type="number" id="stuRoll" placeholder="Roll" class="border p-2 rounded"><button onclick="addStudent()" class="bg-primary text-white px-3 py-2 rounded">Save</button></div></div>
                    <table class="w-full text-sm text-left text-gray-500"><thead class="bg-gray-100"><tr><th class="px-4 py-2">Roll</th><th class="px-4 py-2">Name</th><th class="px-4 py-2">Father</th><th class="px-4 py-2">Action</th></tr></thead><tbody id="studentTableBody"></tbody></table>
                </div>
            </div>

            <!-- EXAM ROUTINE -->
            <div id="routineSection" class="section-content hidden">
                <h1 class="text-2xl font-bold mb-6">Exam Routine Configuration</h1>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-semibold text-lg text-gray-700">Set Dates & Subjects</h3>
                        <div class="space-x-2">
                            <button onclick="addRoutineDate()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ Add Date Column</button>
                            <button onclick="removeRoutineDate()" class="bg-red-500 text-white px-3 py-1 rounded text-sm">- Remove Date</button>
                            <button onclick="saveRoutine()" class="bg-green-600 text-white px-4 py-1 rounded text-sm font-bold">Save Routine</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="routineTable" class="w-full text-sm border-collapse border border-gray-300">
                            <!-- Populated via JS -->
                        </table>
                    </div>
                </div>
            </div>

            <!-- CONFIG -->
            <div id="examConfigSection" class="section-content hidden">
                <h1 class="text-2xl font-bold mb-6">Result Configuration</h1>
                <div class="bg-white p-6 rounded-lg shadow-sm space-y-8">
                    <div class="border-b pb-6"><h3 class="font-semibold mb-3 text-lg">1. Define Exams</h3><div class="flex gap-2"><input type="text" id="examName" placeholder="Exam Name" class="flex-1 border p-2 rounded"><button onclick="addExam()" class="bg-primary text-white px-4 py-2 rounded">Add Exam</button></div><ul id="examList" class="mt-4 space-y-2 text-sm"></ul></div>
                    <div class="border-b pb-6"><h3 class="font-semibold mb-3 text-lg">2. Define Subjects</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><select id="configClassSelect" class="border p-2 rounded" onchange="loadClassSubjects()"></select><div><textarea id="classSubjectsInput" rows="2" class="w-full border p-2 rounded" placeholder="English, Math, Science..."></textarea><button onclick="saveClassSubjects()" class="mt-2 bg-gray-800 text-white px-4 py-2 rounded text-sm w-full">Save Subjects</button></div></div></div>
                    <div><h3 class="font-semibold mb-3 text-lg">3. Configure Max Marks</h3><button onclick="renderMaxMarksGrid()" class="bg-accent text-white px-6 py-2 rounded shadow">Load Marks Configuration</button><div id="maxMarksGridContainer" class="mt-4 overflow-x-auto hidden"></div><button id="saveMaxMarksBtn" onclick="saveMaxMarksConfig()" class="mt-4 bg-green-600 text-white px-6 py-2 rounded hidden">Save Marks Config</button></div>
                </div>
            </div>

            <!-- MARKS -->
            <div id="marksEntrySection" class="section-content hidden">
                <h1 class="text-2xl font-bold mb-6">Enter Marks</h1>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex flex-wrap gap-4 mb-6 border-b pb-4"><select id="markClassSelect" class="border p-2 rounded min-w-[200px]"></select><select id="markExamSelect" class="border p-2 rounded min-w-[200px]"></select><button onclick="loadMarksTable()" class="bg-accent text-white px-6 py-2 rounded">Load Sheet</button></div>
                    <div id="marksTableContainer" class="overflow-x-auto"></div>
                    <div id="saveMarksBtnContainer" class="hidden mt-4 text-right"><button onclick="saveMarks()" class="bg-green-600 text-white px-8 py-3 rounded font-bold shadow">Save Marks</button></div>
                </div>
            </div>

            <!-- REPORTS -->
            <div id="reportsSection" class="section-content hidden">
                <h1 class="text-2xl font-bold mb-6">Reports & Sheets</h1>
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">Select Class</label><select id="reportClassSelect" class="w-full border p-2 rounded"></select></div>
                        <div><label class="block text-sm font-bold text-gray-700 mb-1">Select Exam (For Mark Sheet)</label><select id="reportExamSelect" class="w-full border p-2 rounded"></select></div>
                    </div>
                    <div class="flex flex-wrap gap-2 border-t pt-4">
                        <button onclick="generatePreview('report')" class="bg-primary text-white px-3 py-2 rounded hover:bg-blue-800 text-sm font-medium"><i class="fas fa-id-card"></i> Progress Cards</button>
                        <button onclick="generatePreview('certificate')" class="bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-800 text-sm font-medium"><i class="fas fa-certificate"></i> Certificates</button>
                        <button onclick="generateMarkSheet()" class="bg-teal-600 text-white px-3 py-2 rounded hover:bg-teal-800 text-sm font-medium"><i class="fas fa-table"></i> Class Mark Sheet</button>
                        <button onclick="window.print()" class="ml-auto bg-gray-800 text-white px-4 py-2 rounded hover:bg-black text-sm font-medium"><i class="fas fa-print"></i> Print / PDF</button>
                    </div>
                </div>
                <div class="flex justify-center bg-gray-200 p-4 overflow-auto border rounded-lg h-[500px]"><div id="previewArea" class="w-full flex flex-col items-center space-y-8"><div class="text-center text-gray-400 p-10 bg-white shadow w-full max-w-md rounded mt-10">Select options above and click Generate.</div></div></div>
            </div>

            <!-- RANKING -->
            <div id="progressSection" class="section-content hidden">
                <h1 class="text-2xl font-bold mb-6">Cumulative Rank List</h1>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex gap-4 mb-6 items-end"><div class="flex-1"><label class="block text-sm font-bold text-gray-700 mb-1">Select Class</label><select id="rankClassSelect" class="border p-2 rounded w-full"></select></div><button onclick="generateRankList()" class="bg-green-600 text-white px-8 py-2 rounded hover:bg-green-700 mb-[1px]"><i class="fas fa-list-ol"></i> Generate Cumulative Rank List</button></div>
                    <div id="rankListPreview" class="border p-2 bg-gray-50 text-xs min-h-[100px] mb-4 hidden"></div>
                    <button id="printRankBtn" onclick="window.print()" class="w-full bg-gray-800 text-white py-2 rounded hidden"><i class="fas fa-print"></i> Print Rank List</button>
                </div>
            </div>

            <!-- ADMITS -->
            <div id="admitCardSection" class="section-content hidden">
                <h1 class="text-2xl font-bold mb-6">Generate Admit Cards</h1>
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"><div><label class="block text-sm font-medium text-gray-700 mb-1">Select Class</label><select id="admitClassSelect" class="w-full border p-2 rounded"></select></div><div><label class="block text-sm font-medium text-gray-700 mb-1">Name of Examination</label><input type="text" id="admitExamName" placeholder="e.g., Annual Exam 2025" class="w-full border p-2 rounded"></div></div>
                    <div class="flex justify-end"><button onclick="generateAdmitCards()" class="bg-blue-800 text-white px-8 py-3 rounded font-bold shadow hover:bg-blue-900"><i class="fas fa-id-card"></i> Generate & Preview</button></div>
                </div>
                <div class="mt-8 flex justify-center bg-gray-200 p-4 overflow-auto hidden" id="admitPreviewWrapper"><div id="admitPreviewArea"></div></div>
                <div class="text-center mt-4 hidden" id="admitPrintBtn"><button onclick="window.print()" class="bg-gray-800 text-white px-6 py-3 rounded shadow hover:bg-black"><i class="fas fa-print"></i> Print Admit Cards</button></div>
            </div>
        </main>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDJjHUMwXUExy5yzIjLwKIeF-HCJ0lJvuk",
            authDomain: "school-7e0f2.firebaseapp.com",
            projectId: "school-7e0f2",
            storageBucket: "school-7e0f2.firebasestorage.app",
            messagingSenderId: "1041273059114",
            appId: "1:1041273059114:web:e1de6e0c46857228a8d053"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const dbFirestore = firebase.firestore();
        const APP_ID = 'school_crm_v1';

        // Global State
        let db = { 
            schoolName: "", 
            schoolAddress: "", 
            classes: [], 
            exams: [],
            routine: { dates: [], entries: {} },
            sessionStart: "", // New
            sessionEnd: "",   // New
            lastPromotedYear: "" // Tracks promotion status
        };
        let currentUser = null;

        // AUTH
        auth.onAuthStateChanged(async (user) => {
            const loading = document.getElementById('loadingOverlay');
            const loginScreen = document.getElementById('loginScreen');
            const appLayout = document.getElementById('appLayout');

            if (user) {
                currentUser = user;
                loading.classList.remove('hidden');
                try {
                    const docRef = dbFirestore.collection('artifacts').doc(APP_ID).collection('users').doc(user.uid).collection('school_data').doc('main');
                    const docSnap = await docRef.get();

                    if (docSnap.exists) {
                        db = docSnap.data();
                        if(!db.schoolAddress) db.schoolAddress = "";
                        if(!db.routine) db.routine = { dates: [], entries: {} };
                        if(!db.alumni) db.alumni = []; // Store graduated students
                        
                        // Auto-Correction for Name
                        if (db.schoolName === "New School" && user.displayName && user.displayName !== "New School") {
                            db.schoolName = user.displayName;
                            await docRef.update({ schoolName: user.displayName });
                        }
                    } else {
                        const initialName = user.displayName || "New School";
                        db = { schoolName: initialName, schoolAddress: "", classes: [], exams: [], routine: { dates: ["2025-01-01"], entries: {} }, sessionStart: "", sessionEnd: "", lastPromotedYear: "", alumni: [] };
                        await docRef.set(db);
                    }
                    updateUIOnLogin();
                    loginScreen.classList.add('hidden');
                    appLayout.classList.remove('hidden');
                    
                    // CHECK AUTO PROMOTION STATUS
                    checkAutoPromotion();

                } catch (error) {
                    console.error(error);
                    alert("Error loading data.");
                } finally {
                    loading.classList.add('hidden');
                }
            } else {
                currentUser = null;
                appLayout.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            }
        });

        // --- SESSION & PROMOTION LOGIC ---
        function saveSessionDates() {
            db.sessionStart = document.getElementById('sessionStart').value;
            db.sessionEnd = document.getElementById('sessionEnd').value;
            saveData();
        }

        function checkAutoPromotion() {
            if (!db.sessionEnd) return;
            
            const today = new Date();
            const endDate = new Date(db.sessionEnd);
            const currentYear = endDate.getFullYear();

            // If today is past end date AND we haven't promoted for this year yet
            if (today > endDate && db.lastPromotedYear != currentYear) {
                toggleModal('promotionModal');
            }
        }

        async function executePromotion() {
            const endDate = new Date(db.sessionEnd);
            const currentYear = endDate.getFullYear();
            
            // Backup before destructive action? We rely on Firebase for now.
            
            // Logic: Iterate classes backwards
            // Class[N] students move to Alumni (or drop out if no Alumni list)
            // Class[i] students move to Class[i+1]
            // Class[0] students cleared
            
            const classesCount = db.classes.length;
            if(classesCount > 0) {
                // 1. Move last class to Alumni
                const graduatingStudents = db.classes[classesCount - 1].students;
                if(!db.alumni) db.alumni = [];
                // Add passing year to record
                const grads = graduatingStudents.map(s => ({...s, year: currentYear, class: db.classes[classesCount-1].name}));
                db.alumni = [...db.alumni, ...grads];

                // 2. Shift students up
                for (let i = classesCount - 1; i > 0; i--) {
                    // Deep copy students from lower class
                    // Reset marks for new year
                    const promotedStudents = db.classes[i-1].students.map(s => ({
                        ...s,
                        marks: {} // Clear marks
                    }));
                    db.classes[i].students = promotedStudents;
                }

                // 3. Clear first class (Entry level)
                db.classes[0].students = [];
                
                // 4. Update flag
                db.lastPromotedYear = currentYear;
                
                await saveData();
                toggleModal('promotionModal');
                alert("Promotion Successful! Students have moved to the next class.");
                renderStudentList();
                updateStats();
            }
        }

        // --- AUTH & COMMON ---
        async function handleLogin(e) { e.preventDefault(); /*...*/ const email=document.getElementById('loginEmail').value; const pass=document.getElementById('loginPassword').value; try{document.getElementById('loadingOverlay').classList.remove('hidden'); await auth.signInWithEmailAndPassword(email, pass);}catch(e){document.getElementById('loadingOverlay').classList.add('hidden'); document.getElementById('authError').textContent=e.message; document.getElementById('authError').classList.remove('hidden');} }
        async function handleRegister(e) { e.preventDefault(); /*...*/ const name=document.getElementById('regSchoolName').value; const email=document.getElementById('regEmail').value; const pass=document.getElementById('regPassword').value; const confirm=document.getElementById('regConfirmPassword').value; if(pass!==confirm)return alert("Passwords mismatch"); try{document.getElementById('loadingOverlay').classList.remove('hidden'); const cred=await auth.createUserWithEmailAndPassword(email, pass); await cred.user.updateProfile({displayName:name}); db={schoolName:name, schoolAddress:"", classes:[], exams:[], routine:{dates:["2025-01-01"], entries:{}}, sessionStart:"", sessionEnd:"", lastPromotedYear:"", alumni:[]}; await dbFirestore.collection('artifacts').doc(APP_ID).collection('users').doc(cred.user.uid).collection('school_data').doc('main').set(db); updateUIOnLogin();}catch(e){document.getElementById('loadingOverlay').classList.add('hidden'); document.getElementById('authError').textContent=e.message; document.getElementById('authError').classList.remove('hidden');} }
        function handleLogout(){auth.signOut();}
        function switchTab(tab){if(tab==='login'){document.getElementById('loginForm').classList.remove('hidden');document.getElementById('registerForm').classList.add('hidden');}else{document.getElementById('loginForm').classList.add('hidden');document.getElementById('registerForm').classList.remove('hidden');}}
        async function editSchoolProfile(){const name=prompt("Edit School Name:",db.schoolName);if(name!==null){const address=prompt("Edit School Address:",db.schoolAddress||"");if(address!==null){db.schoolName=name.trim();db.schoolAddress=address.trim();updateUIOnLogin();await saveData();}}}
        async function saveData(){if(!currentUser)return;await dbFirestore.collection('artifacts').doc(APP_ID).collection('users').doc(currentUser.uid).collection('school_data').doc('main').set(db);showToast();updateStats();}
        function showToast(){const t=document.getElementById('toast');t.classList.remove('translate-x-full');setTimeout(()=>t.classList.add('translate-x-full'),2000);}
        function updateUIOnLogin(){document.getElementById('ribbonSchoolName').textContent=db.schoolName;document.getElementById('displaySchoolName').textContent=db.schoolName;document.getElementById('displaySchoolAddress').textContent=db.schoolAddress||"Add Address";document.getElementById('sessionStart').value=db.sessionStart||"";document.getElementById('sessionEnd').value=db.sessionEnd||"";document.getElementById('welcomeRibbon').classList.remove('hidden');updateStats();renderTags();renderExams();populateDropdowns();renderRoutineTable();}
        
        // --- ROUTINE LOGIC ---
        function renderRoutineTable() {
            const table = document.getElementById('routineTable');
            if(!db.routine) db.routine = { dates: [], entries: {} };
            
            let thead = `<thead class="bg-gray-200"><tr><th class="border p-2 w-32">Class</th>`;
            db.routine.dates.forEach((d, i) => {
                thead += `<th class="border p-2"><input type="date" value="${d}" onchange="updateRoutineDate(${i}, this.value)" class="w-full bg-transparent border-none font-bold text-center"></th>`;
            });
            thead += `</tr></thead>`;
            
            let tbody = `<tbody>`;
            db.classes.forEach(cls => {
                tbody += `<tr><td class="border p-2 font-bold bg-gray-50">${cls.name}</td>`;
                db.routine.dates.forEach((_, dateIdx) => {
                    const val = (db.routine.entries[cls.name] && db.routine.entries[cls.name][dateIdx]) || "";
                    tbody += `<td class="border p-1"><input type="text" value="${val}" onchange="updateRoutineSubject('${cls.name}', ${dateIdx}, this.value)" class="w-full border rounded p-1 text-center" placeholder="-"></td>`;
                });
                tbody += `</tr>`;
            });
            tbody += `</tbody>`;
            
            table.innerHTML = thead + tbody;
        }

        window.addRoutineDate = () => { if(!db.routine) db.routine={dates:[],entries:{}}; db.routine.dates.push(new Date().toISOString().split('T')[0]); renderRoutineTable(); };
        window.removeRoutineDate = () => { if(db.routine.dates.length>0){db.routine.dates.pop(); renderRoutineTable();} };
        window.updateRoutineDate = (idx, val) => { db.routine.dates[idx] = val; };
        window.updateRoutineSubject = (clsName, dateIdx, val) => { if(!db.routine.entries[clsName]) db.routine.entries[clsName]=[]; db.routine.entries[clsName][dateIdx]=val; };
        window.saveRoutine = () => { saveData(); };

        // --- APP FUNCTIONS ---
        function showSection(id){document.querySelectorAll('.section-content').forEach(e=>e.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');if(id==='routineSection')renderRoutineTable();}
        function updateStats(){document.getElementById('dashTotalStudents').textContent=db.classes.reduce((a,c)=>a+c.students.length,0);document.getElementById('dashTotalClasses').textContent=db.classes.length;document.getElementById('dashTotalExams').textContent=db.exams.length;}
        window.addClass=()=>{const name=document.getElementById('newClassName').value.trim();if(!name)return;db.classes.push({name,students:[],subjects:[],marksConfig:{}});document.getElementById('newClassName').value='';saveData();renderTags();populateDropdowns();renderRoutineTable();};
        window.renderTags=()=>{document.getElementById('classListContainer').innerHTML=db.classes.map(c=>`<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm border border-blue-200">${c.name}</span>`).join('');};
        window.addStudent=()=>{const clsIdx=document.getElementById('studentClassSelect').selectedIndex-1;if(clsIdx<0)return alert("Select Class");const name=document.getElementById('stuName').value;const roll=document.getElementById('stuRoll').value;if(!name||!roll)return alert("Required");db.classes[clsIdx].students.push({name,roll,id:document.getElementById('stuID').value,father:document.getElementById('stuFather').value,marks:{},extra:{dob:'',phone:'',address:''}});db.classes[clsIdx].students.sort((a,b)=>a.roll-b.roll);saveData();renderStudentList();document.getElementById('stuName').value='';document.getElementById('stuFather').value='';document.getElementById('stuID').value='';document.getElementById('stuRoll').value='';};
        window.renderStudentList=()=>{const ci=document.getElementById('studentClassSelect').selectedIndex-1;if(ci<0)return document.getElementById('studentTableBody').innerHTML='';document.getElementById('studentTableBody').innerHTML=db.classes[ci].students.map((s,i)=>`<tr class="border-b"><td class="px-4 py-2">${s.roll}</td><td class="px-4 py-2">${s.name}</td><td class="px-4 py-2">${s.father}</td><td class="px-4 py-2 flex gap-2"><button onclick="editStudent(${ci},${i})" class="text-blue-600"><i class="fas fa-edit"></i></button><button onclick="delStu(${ci},${i})" class="text-red-600"><i class="fas fa-trash"></i></button></td></tr>`).join('');};
        window.delStu=(ci,si)=>{if(confirm("Delete?")){db.classes[ci].students.splice(si,1);saveData();renderStudentList();}};
        
        // --- EDIT STUDENT (UPDATED) ---
        window.editStudent = (ci, si) => { 
            const s = db.classes[ci].students[si]; 
            document.getElementById('editStuClassIdx').value=ci; 
            document.getElementById('editStuIdx').value=si; 
            document.getElementById('editStuName').value=s.name; 
            document.getElementById('editStuFather').value=s.father; 
            document.getElementById('editStuRoll').value=s.roll; 
            document.getElementById('editStuID').value=s.id; 
            if(!s.extra)s.extra={dob:'',phone:'',address:''}; 
            document.getElementById('editStuDOB').value=s.extra.dob||''; 
            document.getElementById('editStuPhone').value=s.extra.phone||''; 
            document.getElementById('editStuAddress').value=s.extra.address||''; 
            
            // Populate Class Dropdown
            const clsSelect = document.getElementById('editStuClassSelect');
            clsSelect.innerHTML = db.classes.map((c, idx) => `<option value="${idx}" ${idx === ci ? 'selected' : ''}>${c.name}</option>`).join('');
            
            toggleModal('editStudentModal'); 
        };

        window.saveEditedStudent = () => { 
            const originalCi = parseInt(document.getElementById('editStuClassIdx').value);
            const si = parseInt(document.getElementById('editStuIdx').value);
            const newCi = parseInt(document.getElementById('editStuClassSelect').value);
            
            // Get current student object
            const s = db.classes[originalCi].students[si];
            
            // Update fields
            s.name = document.getElementById('editStuName').value;
            s.father = document.getElementById('editStuFather').value;
            s.roll = document.getElementById('editStuRoll').value;
            s.id = document.getElementById('editStuID').value;
            s.extra = {
                dob: document.getElementById('editStuDOB').value,
                phone: document.getElementById('editStuPhone').value,
                address: document.getElementById('editStuAddress').value
            };

            // Handle Class Change
            if (originalCi !== newCi) {
                // Remove from old class
                db.classes[originalCi].students.splice(si, 1);
                // Add to new class
                db.classes[newCi].students.push(s);
                // Sort new class
                db.classes[newCi].students.sort((a,b) => a.roll - b.roll);
                // Refresh list if we are currently viewing either class
                const currentViewClass = document.getElementById('studentClassSelect').selectedIndex - 1;
                if (currentViewClass === originalCi || currentViewClass === newCi) {
                    renderStudentList();
                }
            } else {
                // Same class, just re-sort
                db.classes[originalCi].students.sort((a,b) => a.roll - b.roll);
                renderStudentList();
            }

            saveData(); 
            toggleModal('editStudentModal'); 
        };

        window.toggleModal=(id)=>{document.getElementById(id).classList.toggle('opacity-0');document.getElementById(id).classList.toggle('pointer-events-none');};
        window.addExam=()=>{const name=document.getElementById('examName').value;if(!name)return;db.exams.push({name});document.getElementById('examName').value='';saveData();renderExams();populateDropdowns();};
        window.renderExams=()=>{document.getElementById('examList').innerHTML=db.exams.map((e,i)=>`<li class="flex justify-between bg-gray-50 p-2 border rounded"><span>${e.name}</span><button class="text-red-500" onclick="delExam(${i})">x</button></li>`).join('');};
        window.delExam=(i)=>{db.exams.splice(i,1);saveData();renderExams();populateDropdowns();};
        window.loadClassSubjects=()=>{const i=document.getElementById('configClassSelect').selectedIndex-1;if(i>=0)document.getElementById('classSubjectsInput').value=(db.classes[i].subjects||[]).join(', ');};
        window.saveClassSubjects=()=>{const i=document.getElementById('configClassSelect').selectedIndex-1;if(i<0)return;db.classes[i].subjects=document.getElementById('classSubjectsInput').value.split(',').map(s=>s.trim()).filter(s=>s);saveData();};
        window.renderMaxMarksGrid=()=>{const ci=document.getElementById('configClassSelect').selectedIndex-1;if(ci<0)return;const cls=db.classes[ci];let h=`<table class="w-full text-sm border-collapse"><thead><tr class="bg-gray-100"><th class="border p-2">Subject</th>`+db.exams.map(e=>`<th class="border p-2">${e.name}</th>`).join('')+`</tr></thead><tbody>`;cls.subjects.forEach(sub=>{h+=`<tr><td class="border p-2 font-bold">${sub}</td>`+db.exams.map(e=>`<td class="border p-1"><input type="number" class="config-max-input w-full p-1 border text-center" data-exam="${e.name}" data-sub="${sub}" value="${(cls.marksConfig&&cls.marksConfig[e.name]&&cls.marksConfig[e.name][sub])||100}"></td>`).join('')+`</tr>`;});document.getElementById('maxMarksGridContainer').innerHTML=h+`</tbody></table>`;document.getElementById('maxMarksGridContainer').classList.remove('hidden');document.getElementById('saveMaxMarksBtn').classList.remove('hidden');};
        window.saveMaxMarksConfig=()=>{const ci=document.getElementById('configClassSelect').selectedIndex-1;if(!db.classes[ci].marksConfig)db.classes[ci].marksConfig={};document.querySelectorAll('.config-max-input').forEach(i=>{const e=i.dataset.exam,s=i.dataset.sub;if(!db.classes[ci].marksConfig[e])db.classes[ci].marksConfig[e]={};db.classes[ci].marksConfig[e][s]=parseInt(i.value)||0;});saveData();};
        window.loadMarksTable=()=>{const ci=document.getElementById('markClassSelect').selectedIndex-1;const ei=document.getElementById('markExamSelect').selectedIndex-1;if(ci<0||ei<0)return;const cls=db.classes[ci],en=db.exams[ei].name;let h=`<table class="w-full border-collapse text-sm"><thead><tr class="bg-gray-200"><th class="border p-2">Roll</th><th class="border p-2">Name</th>`+cls.subjects.map(s=>`<th class="border p-2">${s} /${(cls.marksConfig&&cls.marksConfig[en]&&cls.marksConfig[en][s])||100}</th>`).join('')+`</tr></thead><tbody>`;cls.students.forEach((s,i)=>{h+=`<tr><td class="border p-2 font-bold">${s.roll}</td><td class="border p-2">${s.name}</td>`+cls.subjects.map(sub=>`<td class="border p-1"><input type="number" class="mark-input w-full p-1 border text-center" data-si="${i}" data-sub="${sub}" value="${(s.marks[en]&&s.marks[en][sub])!==undefined?s.marks[en][sub]:''}"></td>`).join('')+`</tr>`;});document.getElementById('marksTableContainer').innerHTML=h+`</tbody></table>`;document.getElementById('saveMarksBtnContainer').classList.remove('hidden');};
        window.saveMarks=()=>{const ci=document.getElementById('markClassSelect').selectedIndex-1;const ei=document.getElementById('markExamSelect').selectedIndex-1;const en=db.exams[ei].name;document.querySelectorAll('.mark-input').forEach(i=>{const si=i.dataset.si,sub=i.dataset.sub;if(!db.classes[ci].students[si].marks[en])db.classes[ci].students[si].marks[en]={};if(i.value!=='')db.classes[ci].students[si].marks[en][sub]=parseFloat(i.value);});saveData();};
        window.populateDropdowns=()=>{const cOpt=`<option value="">-- Select --</option>`+db.classes.map((c,i)=>`<option value="${i}">${c.name}</option>`).join('');['studentClassSelect','markClassSelect','reportClassSelect','configClassSelect','admitClassSelect','rankClassSelect'].forEach(id=>{if(document.getElementById(id))document.getElementById(id).innerHTML=cOpt});const eOpt=`<option value="">-- Select --</option>`+db.exams.map((e,i)=>`<option value="${i}">${e.name}</option>`).join('');document.getElementById('markExamSelect').innerHTML=eOpt;if(document.getElementById('reportExamSelect'))document.getElementById('reportExamSelect').innerHTML=eOpt;};
        
        // --- ADMIT CARD GENERATOR (Updated with Address & Routine) ---
        window.generateAdmitCards = () => {
            const ci = document.getElementById('admitClassSelect').selectedIndex - 1;
            const examName = document.getElementById('admitExamName').value;
            // Removed specific single date input, using routine table instead
            
            if(ci < 0 || !examName) return alert("Select Class and Enter Exam Name.");
            const cls = db.classes[ci];
            if(cls.students.length === 0) return alert("No students.");

            // Build Routine Table HTML for this class
            let routineHtml = '';
            if(db.routine && db.routine.dates.length > 0 && db.routine.entries[cls.name]) {
                routineHtml = `<div class="mt-2 border-t border-b py-1"><table class="w-full text-xs"><tr>`;
                db.routine.dates.forEach((d, idx) => {
                    const sub = db.routine.entries[cls.name][idx];
                    if(sub && sub.trim() !== "" && sub !== "-") {
                        routineHtml += `<td class="pr-2 border-r last:border-0">
                            <div class="font-bold text-[10px] text-gray-500">${d}</div>
                            <div class="font-semibold">${sub}</div>
                        </td>`;
                    }
                });
                routineHtml += `</tr></table></div>`;
            }

            let html = '';
            for(let i=0; i<cls.students.length; i+=4) {
                html += `<div class="a4-paper"><div class="admit-grid">`;
                cls.students.slice(i, i+4).forEach(s => {
                    html += `
                    <div class="admit-card">
                        <div class="text-center border-b pb-2 mb-2">
                            <h2 class="font-bold text-blue-900 uppercase text-lg tracking-wider">${db.schoolName}</h2>
                            <p class="text-xs text-gray-600">${db.schoolAddress || ""}</p>
                            <div class="mt-1 bg-blue-900 text-white text-xs inline-block px-3 py-0.5 rounded-full uppercase tracking-widest">Admit Card</div>
                        </div>
                        <div class="flex-1 text-sm space-y-1 mt-1">
                            <div class="flex border-b border-dotted pb-1"><span class="w-24 font-semibold text-gray-600">Exam:</span> <span class="font-bold">${examName}</span></div>
                            <div class="flex border-b border-dotted pb-1 pt-1"><span class="w-24 font-semibold text-gray-600">Student:</span> <span class="font-bold uppercase">${s.name}</span></div>
                            <div class="flex border-b border-dotted pb-1 pt-1"><span class="w-24 font-semibold text-gray-600">Father:</span> <span class="uppercase">${s.father}</span></div>
                            <div class="flex border-b border-dotted pb-1 pt-1"><span class="w-24 font-semibold text-gray-600">Details:</span> <span>Class: <b>${cls.name}</b> | Roll: <b>${s.roll}</b> | ID: <b>${s.id}</b></span></div>
                            ${routineHtml}
                        </div>
                        <div class="mt-4 pt-2 border-t flex justify-end items-end text-xs text-gray-500">
                            <div class="text-center w-24 border-t border-gray-400 pt-1">Principal</div>
                        </div>
                    </div>`;
                });
                html += `</div></div>`;
            }
            document.getElementById('admitPreviewArea').innerHTML=html;
            document.getElementById('printContainer').innerHTML=html;
            document.getElementById('admitPreviewWrapper').classList.remove('hidden');
            document.getElementById('admitPrintBtn').classList.remove('hidden');
        };

        // --- BULK REPORTS (Updated with Address) ---
        window.generatePreview = (type) => {
            const ci = document.getElementById('reportClassSelect').selectedIndex - 1;
            if(ci < 0) return alert("Select Class");
            const cls = db.classes[ci];
            let allContent = '';
            let chartDataList = [];

            cls.students.forEach((s, idx) => {
                const addressBlock = db.schoolAddress ? `<p class="text-sm text-gray-600">${db.schoolAddress}</p>` : '';
                if (type === 'report') {
                    let chartId = `reportChart_${idx}`;
                    allContent += `<div class="a4-paper"><div class="text-center border-b-2 border-gray-800 pb-4 mb-6"><h1 class="text-4xl font-bold uppercase text-blue-900">${db.schoolName}</h1>${addressBlock}<p class="text-gray-600 mt-1 font-semibold uppercase tracking-widest">Progress Report</p></div><div class="grid grid-cols-2 gap-4 text-sm mb-6"><div>Name: <b>${s.name}</b></div><div>Class: <b>${cls.name}</b></div><div>Father: <b>${s.father}</b></div><div>Roll: <b>${s.roll}</b> | ID: <b>${s.id}</b></div></div><table class="w-full border-collapse border border-gray-400 text-sm mb-6"><thead><tr class="bg-gray-100"><th class="border border-gray-400 p-2">Subject</th>` + db.exams.map(e => `<th class="border border-gray-400 p-2">${e.name}</th>`).join('') + `<th class="border border-gray-400 p-2">Total</th><th class="border border-gray-400 p-2">Grade</th></tr></thead><tbody>`;
                    
                    let labels = [], data = [];
                    cls.subjects.forEach(sub => {
                        let subTotal = 0, maxTotal = 0;
                        let row = `<tr><td class="border border-gray-400 p-2 font-bold">${sub}</td>`;
                        db.exams.forEach(e => {
                            const obt = (s.marks[e.name] && s.marks[e.name][sub]) !== undefined ? s.marks[e.name][sub] : '-';
                            const max = (cls.marksConfig && cls.marksConfig[e.name] && cls.marksConfig[e.name][sub]) || 100;
                            row += `<td class="border border-gray-400 p-2 text-center">${obt} <span class="text-xs text-gray-500">/${max}</span></td>`;
                            if(obt !== '-') { subTotal += obt; maxTotal += max; }
                        });
                        const pct = maxTotal > 0 ? (subTotal/maxTotal)*100 : 0;
                        row += `<td class="border border-gray-400 p-2 text-center font-bold">${subTotal} / ${maxTotal}</td><td class="border border-gray-400 p-2 text-center">${getGrade(pct)}</td></tr>`;
                        allContent += row;
                    });
                    
                    db.exams.forEach(e => {
                        let totalObt = 0, totalMax = 0;
                        cls.subjects.forEach(sub => {
                            const obt = (s.marks[e.name] && s.marks[e.name][sub]) || 0;
                            const max = (cls.marksConfig && cls.marksConfig[e.name] && cls.marksConfig[e.name][sub]) || 100;
                            totalObt += obt; totalMax += max;
                        });
                        if(totalMax > 0) { labels.push(e.name); data.push((totalObt/totalMax)*100); }
                    });
                    if(labels.length > 0) { chartDataList.push({ id: chartId, labels: labels, data: data }); }
                    
                    allContent += `</tbody></table><div class="h-64 mb-6"><canvas id="${chartId}"></canvas></div><div class="flex justify-between text-sm pt-8 mt-8"><div class="text-center w-1/4 border-t border-gray-400 pt-2">Class Teacher</div><div class="text-center w-1/4 border-t border-gray-400 pt-2">Principal</div><div class="text-center w-1/4 border-t border-gray-400 pt-2">Parent</div></div></div>`;
                } else {
                    allContent += `<div class="a4-paper flex flex-col justify-center items-center text-center border-8 border-double border-blue-900 p-10"><i class="fas fa-award text-6xl text-yellow-500 mb-6"></i><h1 class="text-5xl font-serif font-bold text-blue-900 mb-2">Certificate of Merit</h1>${addressBlock}<p class="text-lg text-gray-600 mb-10 mt-4">This certifies that</p><h2 class="text-4xl font-bold border-b-2 border-gray-300 pb-2 px-10 mb-4">${s.name}</h2><p class="text-lg text-gray-700 mb-8">Son/Daughter of <b>${s.father}</b><br>Class: <b>${cls.name}</b> | Student ID: <b>${s.id}</b></p><p class="max-w-2xl text-gray-600 leading-relaxed mb-12">Has successfully completed the academic requirements for the year.</p><div class="flex justify-between w-full px-10 mt-auto mb-10"><div class="text-center"><div class="w-40 border-b border-gray-800 mb-2"></div><div class="font-bold">Date</div></div><div class="text-center"><div class="w-40 border-b border-gray-800 mb-2"></div><div class="font-bold">Principal</div></div></div></div>`;
                }
            });
            document.getElementById('previewArea').innerHTML = allContent;
            document.getElementById('printContainer').innerHTML = allContent;
            
            setTimeout(() => {
                chartDataList.forEach(item => {
                    const ctx = document.getElementById(item.id);
                    if (ctx) new Chart(ctx, { type: 'bar', data: { labels: item.labels, datasets: [{ label: 'Overall %', data: item.data, backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } } });
                    const printC = document.getElementById('printContainer');
                    printC.innerHTML = printC.innerHTML.replace(new RegExp(item.id, 'g'), 'print_' + item.id);
                    const ctxP = document.getElementById('print_' + item.id);
                    if(ctxP) new Chart(ctxP, { type: 'bar', data: { labels: item.labels, datasets: [{ label: 'Overall %', data: item.data, backgroundColor: '#3b82f6' }] }, options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { y: { beginAtZero: true, max: 100 } } } });
                });
            }, 500);
        };

        // --- MARK SHEET (Updated with Address) ---
        window.generateMarkSheet = () => {
            const ci = document.getElementById('reportClassSelect').selectedIndex - 1;
            const ei = document.getElementById('reportExamSelect').selectedIndex - 1;
            if(ci < 0 || ei < 0) return alert("Select Class and Exam.");
            const cls = db.classes[ci];
            const exam = db.exams[ei];
            const addressBlock = db.schoolAddress ? `<p class="text-sm text-gray-600">${db.schoolAddress}</p>` : '';
            
            let html = `<div class="a4-paper"><div class="text-center border-b-2 border-gray-800 pb-2 mb-4"><h1 class="text-2xl font-bold uppercase">${db.schoolName}</h1>${addressBlock}<p class="text-sm text-gray-600 mt-1">Class Mark Sheet | Exam: ${exam.name} | Class: ${cls.name}</p></div><table class="w-full text-xs border-collapse border border-gray-400 text-center"><thead><tr class="bg-gray-200 font-bold"><th class="border border-gray-400 p-1">Roll</th><th class="border border-gray-400 p-1 text-left">Name</th>` + cls.subjects.map(s=>`<th class="border border-gray-400 p-1">${s}</th>`).join('') + `<th class="border border-gray-400 p-1">Total</th><th class="border border-gray-400 p-1">%</th><th class="border border-gray-400 p-1">Rank</th></tr></thead><tbody>`;
            
            let studentsWithScores = cls.students.map(s => {
                let totalObt = 0;
                let totalMax = 0;
                cls.subjects.forEach(sub => {
                    const obt = (s.marks[exam.name] && s.marks[exam.name][sub]) || 0;
                    const max = (cls.marksConfig && cls.marksConfig[exam.name] && cls.marksConfig[exam.name][sub]) || 100;
                    totalObt += obt;
                    totalMax += max;
                });
                return { ...s, totalObt, totalMax, pct: totalMax > 0 ? (totalObt/totalMax)*100 : 0 };
            }).sort((a, b) => b.totalObt - a.totalObt);
            
            studentsWithScores.forEach((s, idx) => {
                html += `<tr><td class="border border-gray-400 p-1">${s.roll}</td><td class="border border-gray-400 p-1 text-left">${s.name}</td>` + cls.subjects.map(sub=>`<td class="border border-gray-400 p-1">${(s.marks[exam.name]&&s.marks[exam.name][sub])!==undefined?s.marks[exam.name][sub]:'-'}</td>`).join('') + `<td class="border border-gray-400 p-1 font-bold">${s.totalObt}</td><td class="border border-gray-400 p-1">${s.pct.toFixed(1)}%</td><td class="border border-gray-400 p-1 font-bold">#${idx+1}</td></tr>`;
            });
            html += `</tbody></table><div class="flex justify-between w-full mt-10 px-10"><div class="text-center"><div class="w-32 border-t border-gray-800 mb-1"></div><div class="text-xs">Teacher</div></div><div class="text-center"><div class="w-32 border-t border-gray-800 mb-1"></div><div class="text-xs">Principal</div></div></div></div>`;
            document.getElementById('previewArea').innerHTML=html;
            document.getElementById('printContainer').innerHTML=html;
        };
        
        window.generateRankList = () => {
            const ci = document.getElementById('rankClassSelect').selectedIndex - 1;
            if(ci < 0) return alert("Select Class");
            const cls = db.classes[ci];
            const addressBlock = db.schoolAddress ? `<p class="text-sm text-gray-600">${db.schoolAddress}</p>` : '';
            let rankedList = cls.students.map(s => {
                let grandTotalObt = 0;
                let grandTotalMax = 0;
                db.exams.forEach(exam => {
                    (cls.subjects || []).forEach(sub => {
                         const obt = (s.marks[exam.name] && s.marks[exam.name][sub]) || 0;
                         const max = (cls.marksConfig && cls.marksConfig[exam.name] && cls.marksConfig[exam.name][sub]) || 100;
                         grandTotalObt += obt; grandTotalMax += max;
                    });
                });
                return { ...s, grandTotalObt, grandTotalMax, pct: grandTotalMax > 0 ? (grandTotalObt/grandTotalMax)*100 : 0 };
            }).sort((a, b) => b.grandTotalObt - a.grandTotalObt);

            let html = `
            <div class="a4-paper">
                <div class="text-center border-b-2 border-gray-800 pb-2 mb-4"><h1 class="text-2xl font-bold uppercase">${db.schoolName}</h1>${addressBlock}<p class="text-sm text-gray-600 mt-1">Cumulative Rank List (All Exams) | Class: ${cls.name}</p></div>
                <table class="w-full text-sm border-collapse border border-gray-400">
                    <thead><tr class="bg-gray-200"><th class="border border-gray-400 p-2">Rank</th><th class="border border-gray-400 p-2">Roll</th><th class="border border-gray-400 p-2 text-left">Student Name</th><th class="border border-gray-400 p-2">Total Marks</th><th class="border border-gray-400 p-2">Obtained</th><th class="border border-gray-400 p-2">%</th></tr></thead>
                    <tbody>`;
            rankedList.forEach((s, idx) => {
                html += `<tr><td class="border border-gray-400 p-2 text-center font-bold">${idx+1}</td><td class="border border-gray-400 p-2 text-center">${s.roll}</td><td class="border border-gray-400 p-2">${s.name}</td><td class="border border-gray-400 p-2 text-center">${s.grandTotalMax}</td><td class="border border-gray-400 p-2 text-center font-bold">${s.grandTotalObt}</td><td class="border border-gray-400 p-2 text-center">${s.pct.toFixed(1)}%</td></tr>`;
            });
            html += `</tbody></table><div class="text-right text-xs text-gray-400 mt-4">Generated on ${new Date().toLocaleDateString()}</div></div>`;
            document.getElementById('rankListPreview').innerHTML=html;
            document.getElementById('rankListPreview').classList.remove('hidden');
            document.getElementById('printContainer').innerHTML=html;
            document.getElementById('printRankBtn').classList.remove('hidden');
        };
    </script>
</body>
</html>


